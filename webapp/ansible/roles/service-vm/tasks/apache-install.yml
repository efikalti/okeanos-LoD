---

  - name: Install apache2, apache2-dev and libapache2-mod-wsgi packages.
    apt: name={{ item }} state=latest
    with_items:
      - apache2
      - apache2-dev
      - libapache2-mod-wsgi

  - name: Install apache modules
    apache2_module: name={{item}} state=present
    with_items:
      - ssl
      - rewrite
      - headers
    notify: restart_apache2

  - name: Create /etc/apache2/ssl directory
    file: path=/etc/apache2/ssl state=directory owner=root group=root mode=0744

  - name: Create self-signed certificate
    command: openssl req -new -nodes -x509 -subj "/C=GR/O=GRNET S.A./OU=okeanos.grnet.gr/CN={{ ansible_hostname }}.vm.okeanos.grnet.gr" -days 3650 -keyout /etc/apache2/ssl/server.key -out /etc/apache2/ssl/server.crt -extensions v3_ca creates=/etc/apache2/ssl/server.crt
    tags:
      - image-configure

  - name: Change permissions of private key
    file: path=/etc/apache2/ssl/server.key mode=400 owner=root group=root
    tags:
      - image-configure

  - name: Change permissions of certificate
    file: path=/etc/apache2/ssl/server.crt mode=644 owner=root group=root
    tags:
      - image-configure

  - name: Copy Lambda sites-available backend configuration.
    template: src=lambda-service.conf.j2 dest=/etc/apache2/sites-available/lambda-service.conf
    notify:
          - restart_apache2
    tags:
      - image-configure

  - name: Add lambda-service to sites-enabled.
    command: a2ensite lambda-service.conf
    notify:
          - restart_apache2
    tags:
      - image-configure

  - name: Disable default apache sites.
    command: a2dissite {{ item }}
    with_items:
      - 000-default.conf
      - default-ssl.conf
    notify:
      - restart_apache2

  - name: Configure Apache.
    lineinfile: dest=/etc/apache2/apache2.conf line="WSGIPythonPath {{ repository_download_path }}/okeanos-LoD/webapp" state=present insertafter=EOF
    notify:
      - restart_apache2
